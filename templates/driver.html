{% extends "base.html" %}

{% block title %}Driver Panel - Campus Sphere{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <div class="glass-card rounded-2xl p-8 shadow-2xl">
            <h1 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">Driver Panel</h1>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Bus</label>
                    <div class="px-4 py-3 bg-gray-100 rounded-lg">
                        <p class="text-lg font-semibold">Bus {{ driver.bus.bus_number if driver.bus else 'Not Assigned' }}</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location Sharing Status</label>
                    <div class="flex items-center justify-between px-4 py-3 bg-gray-100 rounded-lg">
                        <span id="status-text" class="{% if driver.is_sharing_location %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                            {% if driver.is_sharing_location %}Active{% else %}Inactive{% endif %}
                        </span>
                        <div class="w-12 h-12 rounded-full {% if driver.is_sharing_location %}gradient-bg-success{% else %}bg-gray-400{% endif %} flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <button id="toggle-location" onclick="toggleLocationSharing()" class="w-full btn-primary">
                    {% if driver.is_sharing_location %}Stop Sharing Location{% else %}Start Sharing Location{% endif %}
                </button>

                <a href="{{ url_for('driver_logout') }}" class="block w-full text-center px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                    Logout
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let locationInterval = null;
let isSharing = {{ 'true' if driver.is_sharing_location else 'false' }};

function toggleLocationSharing() {
    if (isSharing) {
        stopSharing();
    } else {
        startSharing();
    }
}

function startSharing() {
    if ("geolocation" in navigator) {
        locationInterval = setInterval(updateLocation, 5000);
        updateLocation();
        isSharing = true;
        updateUI();
        fetch('/driver/toggle-location', { method: 'POST' });
    } else {
        alert("Geolocation is not supported by your browser");
    }
}

function stopSharing() {
    if (locationInterval) {
        clearInterval(locationInterval);
        locationInterval = null;
    }
    isSharing = false;
    updateUI();
    fetch('/driver/toggle-location', { method: 'POST' });
}

function updateLocation() {
    navigator.geolocation.getCurrentPosition(function(position) {
        fetch('/driver/update-location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                lat: position.coords.latitude,
                lng: position.coords.longitude
            })
        });
    });
}

function updateUI() {
    const statusText = document.getElementById('status-text');
    const button = document.getElementById('toggle-location');
    
    if (isSharing) {
        statusText.textContent = 'Active';
        statusText.className = 'text-green-600 font-semibold';
        button.textContent = 'Stop Sharing Location';
    } else {
        statusText.textContent = 'Inactive';
        statusText.className = 'text-red-600 font-semibold';
        button.textContent = 'Start Sharing Location';
    }
}

if (isSharing) {
    startSharing();
}
</script>
{% endblock %}
